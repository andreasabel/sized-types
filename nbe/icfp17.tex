%% For double-blind review submission
\documentclass[acmlarge,review,anonymous]{acmart}\settopmatter{printfolios=true}
%% For single-blind review submission
%\documentclass[acmlarge,review]{acmart}\settopmatter{printfolios=true}
%% For final camera-ready submission
%\documentclass[acmlarge]{acmart}\settopmatter{}

\usepackage{mathtools} %mathrlap
\usepackage[all]{xy}

\usepackage[cal=boondoxo]{mathalfa}

%% Note: Authors migrating a paper from PACMPL format to traditional
%% SIGPLAN proceedings format should change 'acmlarge' to
%% 'sigplan,10pt'.


%% Some recommended packages.
\usepackage{booktabs}   %% For formal tables:
                        %% http://ctan.org/pkg/booktabs
\usepackage{subcaption} %% For complex figures with subfigures/subcaptions
                        %% http://ctan.org/pkg/subcaption


\makeatletter\if@ACM@journal\makeatother
%% Journal information (used by PACMPL format)
%% Supplied to authors by publisher for camera-ready submission
\acmJournal{PACMPL}
\acmVolume{1}
\acmNumber{1}
\acmArticle{1}
\acmYear{2017}
\acmMonth{1}
\acmDOI{10.1145/nnnnnnn.nnnnnnn}
\startPage{1}
\else\makeatother
%% Conference information (used by SIGPLAN proceedings format)
%% Supplied to authors by publisher for camera-ready submission
\acmConference[PL'17]{ACM SIGPLAN Conference on Programming Languages}{January 01--03, 2017}{New York, NY, USA}
\acmYear{2017}
\acmISBN{978-x-xxxx-xxxx-x/YY/MM}
\acmDOI{10.1145/nnnnnnn.nnnnnnn}
\startPage{1}
\fi


%% Copyright information
%% Supplied to authors (based on authors' rights management selection;
%% see authors.acm.org) by publisher for camera-ready submission
\setcopyright{none}             %% For review submission
%\setcopyright{acmcopyright}
%\setcopyright{acmlicensed}
%\setcopyright{rightsretained}
%\copyrightyear{2017}           %% If different from \acmYear


%% Bibliography style
\bibliographystyle{ACM-Reference-Format}
%% Citation style
%% Note: author/year citations are required for papers published as an
%% issue of PACMPL.
\citestyle{acmauthoryear}   %% For author/year citations

\input{macros}


\begin{document}

%% Title information
\title[NbE for Sized Types]{Normalization by Evaluation for Sized Dependent Types}
%\titlenote{with title note}             %% \titlenote is optional;
                                        %% can be repeated if necessary;
                                        %% contents suppressed with 'anonymous'
%\subtitle{Subtitle}                     %% \subtitle is optional
%\subtitlenote{with subtitle note}       %% \subtitlenote is optional;
                                        %% can be repeated if necessary;
                                        %% contents suppressed with 'anonymous'


%% Author information
%% Contents and number of authors suppressed with 'anonymous'.
%% Each author should be introduced by \author, followed by
%% \authornote (optional), \orcid (optional), \affiliation, and
%% \email.
%% An author may have multiple affiliations and/or emails; repeat the
%% appropriate command.
%% Many elements are not rendered, but should be provided for metadata
%% extraction tools.

%% Author with single affiliation.
\author{Andreas Abel}
\authornote{with author1 note}          %% \authornote is optional;
                                        %% can be repeated if necessary
\orcid{nnnn-nnnn-nnnn-nnnn}             %% \orcid is optional
\affiliation{
  \department{Department of Computer Science and Engineering}
  \institution{Gothenburg University}
  \streetaddress{Rännvägen 6b}
  \city{Göteborg}
%  \state{State1}
  \postcode{41296}
  \country{Sweden}
}
\email{andreas.abel@gu.se}          %% \email is recommended

%% Author with two affiliations and emails.
\author{First2 Last2}
\authornote{with author2 note}          %% \authornote is optional;
                                        %% can be repeated if necessary
\orcid{nnnn-nnnn-nnnn-nnnn}             %% \orcid is optional
\affiliation{
  \position{Position2a}
  \department{Department2a}             %% \department is recommended
  \institution{Institution2a}           %% \institution is required
  \streetaddress{Street2a Address2a}
  \city{City2a}
  \state{State2a}
  \postcode{Post-Code2a}
  \country{Country2a}
}
\email{first2.last2@inst2a.com}         %% \email is recommended
\affiliation{
  \position{Position2b}
  \department{Department2b}             %% \department is recommended
  \institution{Institution2b}           %% \institution is required
  \streetaddress{Street3b Address2b}
  \city{City2b}
  \state{State2b}
  \postcode{Post-Code2b}
  \country{Country2b}
}
\email{first2.last2@inst2b.org}         %% \email is recommended


%% Paper note
%% The \thanks command may be used to create a "paper note" ---
%% similar to a title note or an author note, but not explicitly
%% associated with a particular element.  It will appear immediately
%% above the permission/copyright statement.
\thanks{with paper note}                %% \thanks is optional
                                        %% can be repeated if necesary
                                        %% contents suppressed with 'anonymous'


%% Abstract
%% Note: \begin{abstract}...\end{abstract} environment must come
%% before \maketitle command
\begin{abstract}
Text of abstract \ldots.
\end{abstract}


%% 2012 ACM Computing Classification System (CSS) concepts
%% Generate at 'http://dl.acm.org/ccs/ccs.cfm'.
\begin{CCSXML}
<ccs2012>
<concept>
<concept_id>10011007.10011006.10011008</concept_id>
<concept_desc>Software and its engineering~General programming languages</concept_desc>
<concept_significance>500</concept_significance>
</concept>
<concept>
<concept_id>10003456.10003457.10003521.10003525</concept_id>
<concept_desc>Social and professional topics~History of programming languages</concept_desc>
<concept_significance>300</concept_significance>
</concept>
</ccs2012>
\end{CCSXML}

\ccsdesc[500]{Software and its engineering~General programming languages}
\ccsdesc[300]{Social and professional topics~History of programming languages}
%% End of generated code


%% Keywords
%% comma separated list
\keywords{keyword1, keyword2, keyword3}  %% \keywords is optional


%% \maketitle
%% Note: \maketitle command must come after title commands, author
%% commands, abstract environment, Computing Classification System
%% environment and commands, and keywords command.
\maketitle


\section{Introduction}
\label{sec:intro}

\newpage

\section{Syntax}

Syntax (de Bruijn terms).
\[
\begin{array}{lllrl@{\qquad}l}
\Sort & \ni & s
    & ::= & \Set[\ell] ~(\ell \in \NN)& \mbox{sort (universe)} \\
% \Ann & \ni & \star & ::= & \erased \mid \nonstrict \mid \noterased & \mbox{annotation (irrelevant, shape-irrelevant, relevant)}\\
\Ann & \ni & \star & ::= & \erased \mid \noterased & \mbox{annotation (irrelevant, relevant)}\\
\Exp & \ni & t,u,T,U
    & ::= & w \mid t\,e & \mbox{expressions} \\
\Whnf & \ni & w, W
    & ::= & n \mid s \mid \Size \mid \epiT U T % \mid \piSizeT T
    % \mid \forallT T
    \mid \lambda t% & \mbox{functions} \\ &&
    \mid \Nat a \mid c & \mbox{weak head normal forms} \\ % \mbox{natural numbers} \\
\Data & \ni & c
   & ::= & \zero a \mid \suc a t & \mbox{constructed data} \\
\Ne & \ni & n
    & ::= & \ind i \mid n \, e & \mbox{neutral expressions} \\
\Elim & \ni & e
    & ::= & t \mid a \mid \ann a \mid \case[\ell] T {t_1} t_2 \mid \fix[\ell] T t & \mbox{eliminations} \\
\SizeExp & \ni & a,b & ::= & \infty \mid o \mid \ind i + o ~(o \in \NN) & \mbox{size expressions} \\
\Cxt & \ni & \Gamma, \Delta & ::= & \cempty \mid \erext[\noterased] \Gamma T \mid \erext \Gamma \Size \\
\end{array}
\]
We omit the ``$\noterased$''-markers from $\Gamma$ and $\Pi$ by default.  We write $\forallT T$ for $\erpiT \Size T$.
For concrete function types, we may use a (named dependent) function type notation as syntactic sugar for the corresponding de Bruijn representation.  For instance, $\funT i \Size \Nat i \to \Set[\ell]$ is sugar for $\piT \Size \piT {(\Nat\,\ind 0)} \Set[\ell]$.  We abbreviate this type by \fbox{$\FixK\,\ell$}, and let \fbox{$\FixT\,T$} stand for $\allT i \Size (\funT x {\Nat i} T\, i\, x) \to \funT x {\Nat (i + 1)} T \,(i+1)\, x$. Similar as for $\Pi$, we use named lambda abstraction as sugar for de Bruijn abstraction.  Named abstract takes care of proper lifting of de Bruijn indices, for instance, $\lambda x.\, t x = \lambda. (t \slift)\,\ind 0$ if $t$ is outside the scope of $x$.

Resurrection\cite{pfenning:lics01} \fbox{$\resurrect\Gamma$} removes
the ``$\erased$''-markers from all bindings in $\Gamma$ (\ie, replaces
them by ``$\noterased$''-markers).  Note that, trivially, resurrection is idempotent: $\resurrecttwice\Gamma = \resurrect{\Gamma}$.

We write $\sigma$ and $\tau$ for substitutions, which are lists of terms, and $t \sigma$ for the application of substitution $\sigma$ to term $t$.  We write $\slift^k_m$ for the substitution $(\ind{k+m-1},\dots,\ind{k+1},\ind k)$ which applies to a term with $m$ free indices and increases all of them by $k$.  We write $\slift_m$ for the lifting $\slift^1_m$ and $\sid_m$ for the identity substitution $ \slift^0_m$. The substitution $[u]_m = (\sid_m, u)$ replaces free index $\ind 0$ by term $u$ and decrements all other free indices by $1$. We drop subscript $m$ when clear from the context.

Size increment \fbox{$a + o'$} for $o' \in \NN$ extends addition by $\infty + o' = \infty$ and $(\ind i + o) + o' = \ind i + (o + o')$.  Size comparison \fbox{$a \leq b$} holds if either $b = \infty$ or  $o \leq o'$ where either $a = o$ and $b = o'$ or $a \in \{ o, \ind i + o \}$ and $b = \ind i + o'$.

Judgements.
\[
\begin{array}{l@{\qquad}l}
  \der \Gamma & \mbox{context $\Gamma$ is well-formed} \\
  \Gamma(i) = \eann T & \mbox{in context $\Gamma$, de Bruijn index $i$ has type $T$ and annotation $\evar$} \\
  \Gamma \der a : \Size & \mbox{in context $\Gamma$, size expression $a$ is well-formed} \\
  \Gamma \der t : T & \mbox{in context $\Gamma$, term $t$ has type $T$} \\
  \Gamma \der t = t' : T & \mbox{in context $\Gamma$, terms $t$ and $t'$ are equal of type $T$} \\
%  \Gamma \mid U \der e : T & \mbox{in context $\Gamma$, elimination $e$ goes from $U$ to $T$} \\
%  \Gamma \mid U \der e = e' : T & \mbox{in context $\Gamma$, eliminations $e$ and $e'$ are equal} \\
  \Gamma \der T \leq T' & \mbox{in context $\Gamma$, type $T$ is a subtype of $T'$} \\
  \Gamma \der T : \Adm \ell & \mbox{in context $\Gamma$ type constructor $T$ is admissible for recursion} \\
  \suty \Gamma \sigma \tau \Delta & \mbox{$\sigma$/$\tau$ is a valid term/type-level substitution for $\Delta$} \\
  \sueq \Gamma \sigma {\sigma'} \tau \Delta & \mbox{$\sigma$/$\sigma'$/$\tau$ are a equal term/term/type-level substitutions for $\Delta$} \\
\end{array}
\]
Derived judgements.
\[
\begin{array}{lll@{~}l@{\qquad}l}
  \Gamma \der T & \defas & \Gamma \der T : s & \mforsome s
    & \mbox{in context $\Gamma$, type $T$ is well-formed} \\
  \Gamma \der T = T' & \defas & \Gamma \der T = T' : s & \mforsome s
    & \mbox{in context $\Gamma$, types $T$ and $T'$ are equal} \\
  \Gamma \der a = b : \Size & \defas & \multicolumn 2 {l@{\qquad}} {\Gamma \der a : \Size \mand a = b}
    & \mbox{sizes $a$ and $b$ are well-formed and identical} \\
  \Gamma \der a \leq b : \Size & \defas &
     \multicolumn 2 {l@{\qquad}} {\Gamma \der a : \Size \mand \Gamma \der b : \Size \mand a \leq b}
%     \multicolumn 2 {l@{\qquad}} {\Gamma \der a : \Size \mand \Gamma \der b : \Size \mand a \leq b}
    & \mbox{sizes $a$ and $b$ are well-formed and comparable} \\
%    & \mbox{in context $\Gamma$, well-formed size $a$ is less or equal than well-formed size $b$} \\
\end{array}
\]
Inference rules.

\fbox{$\der \Gamma$} (implies $\der \resurrect \Gamma$).
\[
  \ru{}{\der \cempty}
\qquad
  \ru{\der \Gamma \qquad
      \resurrect \Gamma \der T
    }{\der \cext \Gamma T}
\qquad
  \ru{\der \Gamma
    }{\der \cext \Gamma \Size}
\qquad
  \ru{\der \Gamma
    }{\der \erext \Gamma \Size}
\]

\fbox{$\Gamma(i) = \eann T$} (implies $\resurrect\Gamma \der T$).
\[
  \ru{}{(\eext \Gamma T)(0) = \eann T \slift}
\qquad
  \ru{\Gamma(i) = \eann T
    }{(\cext \Gamma \_)(i+1) = \eann T \slift}
\]

\fbox{$\Gamma \der a : \Size$}  (implies $\der \Gamma$ and $\resurrect \Gamma \der a : \Size$).
\[
  \ru{\der \Gamma}{\Gamma \der \infty : \Size}
\qquad
  \ru{\der \Gamma \qquad \Gamma(i) = \erann[\noterased]\Size
    }{\Gamma \der \ind i + o : \Size
    }
\]

\fbox{$\Gamma \der t : T$}  (implies $\der \Gamma$ and $\resurrect \Gamma \der T$ [and $\resurrect \Gamma \der t : T$]. Note: no rule for $\Gamma \der \Size : s$.)
\begin{gather*}
  \ru{\der \Gamma
    }{\Gamma \der \Set[\ell] : \Set[\ell']
    }{\ell {<} \ell'}
\qquad
  \ru{\Gamma \der U : s \qquad
      \cext \Gamma U \der T : s
    }{\Gamma \der \piT U T : s}
\qquad
  \ru{\cext \Gamma \Size \der T : s
    }{\Gamma \der \epiT \Size T : s}
\qquad
  \ru{%\der \Gamma \qquad
      \Gamma \der a : \Size
    }{\Gamma \der \Nat a : s}
\\[2ex]
  \rux{\der \Gamma \qquad \Gamma(i) = \erann[\noterased] T
    }{\Gamma \der \ind i : T
    }{T \not= \Size}
\qquad
  \ru{\eext \Gamma U \der t : T
    }{\Gamma \der \lambda t : \epiT U T}
\qquad
  \ru{\Gamma \der t : \piT U T \qquad
      \Gamma \der u : U
    }{\Gamma \der t\,u : T[u]}
% \qquad
%   \ru{\Gamma \der t : T \qquad
%       \Gamma \mid T \der e : T'
%     }{\Gamma \der t\,e : T'}
\qquad
  \ru{\Gamma \der t : \piT \Size T \qquad
      \Gamma \der a : \Size
    }{\Gamma \der t\,a : T[a]}
\\[2ex] % \qquad
  \ru{%\Gamma \der a : \Size \qquad
      \resurrect\Gamma \der a, b : \Size
    }{\Gamma \der \zero{a} : \Nat (b + 1)}
\qquad
  \ru{\resurrect\Gamma \der a : \Size \qquad
      \Gamma \der t : \Nat b
    }{\Gamma \der \suc a t : \Nat (b + 1)}
\qquad
  \ru{\Gamma \der t : \forallT T \qquad
      %\Gamma \der a : \Size \qquad
      \resurrect\Gamma \der a,b : \Size
    }{\Gamma \der t \ann a : T[b]}
\\[2ex]
  \ru{\Gamma \der u : \Nat (a + 1) \qquad
      \Gamma \der T : \Nat (a + 1) \to \Set[\ell] \qquad
      \Gamma \der t_z : T \, (\zero{a}) \qquad
      \Gamma \der t_s : (t : \Nat a) \to T \, (\suc{a} t)
    }{\Gamma \der u\,\case[\ell] T {t_z} t_s : T \, u}
\\[2ex]
  \ru{\Gamma \der u : \Nat a \qquad
      \Gamma \der T : \FixK\,\ell \qquad %% \funT i \Size \Nat i \to \Set[\ell] \\
      \Gamma \der t : \FixT\, T
     }{\Gamma \der u\,\fix[\ell] T t : T \,a \, u}
\qquad
  \ru{\Gamma \der t : T \qquad
      \resurrect\Gamma \der T \leq T'
     }{\Gamma \der t : T'}
\end{gather*}
Note: Size is relevant in $T$ as we would like for instance $T\,i\,x = \Nat i$.
% \fbox{$\Gamma \mid U \der e : T$}
% \begin{gather*}
%   \ru{\cext \Gamma U \der T \qquad \Gamma \der u : U
%     }{\Gamma \mid \piT U T \der u : T[u]}
% \qquad
%   \ru{\cext \Gamma \Size \der T \qquad \Gamma \der a : \Size
%     }{\Gamma \mid \piT \Size T \der a : T[a]}
% \qquad
%   \ru{\cext \Gamma \Size \der T \qquad \Gamma \der a : \Size
%     }{\Gamma \mid \forallT T \der \ann a : T[a]}
% \\
%   \ru{
%     }{\Gamma \mid \Nat a \der \fix T t : T \ann a n}
% \end{gather*}


\fbox{$\Gamma \der t = t' : T$} (implies $\resurrect \Gamma \der T$ and $\Gamma \der t,t' : T$ [and $\resurrect\Gamma \der t = t' : T$].)

Computation rules.
\begin{gather*}
  \ru{\cext \Gamma U \der t : T \qquad
      \Gamma \der u : U
    }{\Gamma \der (\lambda t)\,u = t[u] : T[u]}
\qquad
  \ru{\cext \Gamma \Size \der t : T \qquad
      \Gamma \der a : \Size
    }{\Gamma \der (\lambda t)\,a = t[a] : T[a]}
\qquad
  \ru{\erext \Gamma \Size \der t : T \qquad
      \Gamma \der a : \Size \qquad
      \resurrect \Gamma \der b : \Size
    }{\Gamma \der (\lambda t)\,\ann a = t[a] : T[b]}
\\[2ex]
  \ru{\resurrect\Gamma \der b : \Size \qquad
      \Gamma \der T : \Nat (b + 1) \to \Set[\ell] \qquad
      \Gamma \der a : \Size \qquad
      \Gamma \der t_z : T\,\zero{b} \qquad
      \Gamma \der t_s : (n : \Nat b) \to T\,(\suc{b}n)
    }{\Gamma \der (\zero{a})\,\case[\ell] T {t_z} {t_s} = t_z : T\,\zero{a_z}}
\\[2ex]
  \ru{\Gamma \der t : \Nat b \qquad
      \Gamma \der T : \Nat (b + 1) \to \Set[\ell] \qquad
      \Gamma \der a : \Size \qquad
      \Gamma \der t_z : T\,\zero{b} \qquad
      \Gamma \der t_s : (n : \Nat b) \to T\,(\suc{b}n)
    }{\Gamma \der (\suc{a} t)\,\case[\ell] T {t_z} {t_s} = t_s\,t : T\,(\suc{a} t)}
\\[2ex]
  \ru{\Gamma \der c : \Nat b \qquad
      \Gamma \der a : \Size \qquad
      \Gamma \der T : \FixK\,\ell \qquad %% \funT i \Size \Nat i \to \Set[\ell] \\
      \Gamma \der t : \FixT\,T %% \allT i \Size (\funT x {\Nat i} T\, i\, x) \to \funT x {\Nat (i + 1)} T \,(i+1)\, x
     }{\Gamma \der c\,\fix[\ell] T t = t\ann a (\lambda x. x\,\fix[\ell] T t)\, c : T \,b \, c
     }%{c \in \{\zero a, \suc a t'\}}
\end{gather*}
Extensionality rules.
\begin{gather*}
  \ru{\Gamma \der t : \piT U T
    }{\Gamma \der t = \lambda x. t\,x : \piT U T}
\qquad
  \ru{\Gamma \der t : \forallT T \qquad \erext \Gamma \Size \der a : \Size
    }{\Gamma \der t = \lambda i. t \ann a : \forallT T}
\end{gather*}
Congruence rules.
\begin{gather*}
  \ru{\der \Gamma
    }{\Gamma \der \Set[\ell] = \Set[\ell]: \Set[\ell']
    }{\ell {<} \ell'}
\qquad
  \ru{\Gamma \der U = U' : s \qquad
      \cext \Gamma U \der T = T' : s
    }{\Gamma \der \piT U T = \piT{U'}T': s}
\qquad
  \ru{\cext \Gamma \Size \der T = T' : s
    }{\Gamma \der \epiT \Size T = \epiT \Size T' : s}
\\[2ex]
  \ru{%\der \Gamma \qquad
      \Gamma \der a : \Size
    }{\Gamma \der \Nat a = \Nat a : s}
\\[2ex]
  \rux{\der \Gamma \qquad \Gamma(i) = \erann[\noterased] T
    }{\Gamma \der \ind i = \ind i : T
    }{T \not= \Size}
\qquad
  \ru{\eext \Gamma U \der t = t' : T
    }{\Gamma \der \lambda t = \lambda t' : \epiT U T}
\qquad
  \ru{\Gamma \der t = t' : \piT U T \qquad
      \Gamma \der u = u' : U
    }{\Gamma \der t\,u = t'\,u' : T[u]}
% \qquad
%   \ru{\Gamma \der t : T \qquad
%       \Gamma \mid T \der e : T'
%     }{\Gamma \der t\,e : T'}
\\[2ex]
  \ru{\Gamma \der t = t' : \piT \Size T \qquad
      \Gamma \der a : \Size
    }{\Gamma \der t\,a = t'\,a : T[a]}
\qquad
  \ru{\Gamma \der t = t' : \forallT T \qquad
      \Gamma \der a, a' : \Size \qquad
      \resurrect\Gamma \der b : \Size
    }{\Gamma \der t \ann a = t' \ann{a'} : T[b]}
\\[2ex] % \qquad
  \ru{\Gamma \der a, a' : \Size \qquad
      \resurrect\Gamma \der b : \Size
    }{\Gamma \der \zero a = \zero {a'}: \Nat (b + 1)}
\qquad
  \ru{\Gamma \der a, a' : \Size \qquad
      \Gamma \der t = t' : \Nat b
    }{\Gamma \der \suc a t = \suc {a'} t' : \Nat (b + 1)}
\\[2ex]
  \ru{\Gamma \der u = u' : \Nat (a + 1) \qquad
      \Gamma \der T = T' : \Nat (a + 1) \to \Set[\ell] \\
      \Gamma \der t_z = t_z' : T \, (\zero a) \qquad
      \Gamma \der t_s = t_s' : (n : \Nat a) \to T \, (\suc a n)
    }{\Gamma \der u\,\case[\ell] T {t_z} t_s = u'\,\case[\ell] {T'} {t_z'} t_s' : T \, u}
\\[2ex]
  \ru{\Gamma \der u = u' : \Nat a \qquad
      \Gamma \der T = T' : \FixK\,\ell \qquad %% \funT i \Size \Nat i \to \Set[\ell] \\
      \Gamma \der t = t' : \FixT\,T \qquad %% \allT i \Size (\funT x {\Nat i} T \,i\, x) \to \funT x {\Nat (i + 1)} T \,{i+1}\, x
     }{\Gamma \der u\,\fix[\ell] T t = u'\,\fix[\ell] {T'} t' : T \, a \, u}
\qquad
  \ru{\Gamma \der t = t' : T \qquad
      \resurrect\Gamma \der T \leq T'
     }{\Gamma \der t = t' : T'}
\end{gather*}
Equivalence rules.  (Reflexivity is admissible.)
\begin{gather*}
  \ru{\Gamma \der t = t' : T
    }{\Gamma \der t' = t : T}
\qquad
  \ru{\Gamma \der t_1 = t_2 : T \qquad
      \Gamma \der t_2 = t_3 : T
    }{\Gamma \der t_1 = t_3 : T}
\end{gather*}


\fbox{$\Gamma \der T \leq T'$} (implies $\Gamma \der T,T'$)
% (implies $\resurrect \Gamma \der T,T'$)
\begin{gather*}
  \ru{\der \Gamma \qquad \ell {\leq} \ell'
    }{\Gamma \der \Set[\ell] \leq \Set[\ell']}
\qquad
  \ru{\Gamma \der a \leq b : \Size
    }{\Gamma \der \Nat a \leq \Nat b}
\qquad
  \ru{\Gamma \der T = T'
    }{\Gamma \der T \leq T'}
\\[2ex]
  \ru{\Gamma \der U' \leq U \qquad
      \cext \Gamma {U'} \der T \leq T'
    }{\Gamma \der \piT U T \leq \piT {U'} {T'}}
\qquad
  \ru{\cext \Gamma {\Size} \der T \leq T'
    }{\Gamma \der \epiT \Size T \leq \epiT {\Size} {T'}}
\qquad
  \ru{\Gamma \der T_1 \leq T_2 \qquad
      \Gamma \der T_2 \leq T_3
    }{\Gamma \der T_1 \leq T_3}
\qquad
\end{gather*}


Substitution typing. % and equality.
\fbox{$\Gamma \der \tau : \Delta$}
(implies $\der \Gamma$ and $\der \Delta$
 [and $\resurrect\Gamma \der \tau : \Delta$]
 and $\resurrect\Gamma \der \tau : \resurrect \Delta$).

\begin{gather*}
  \ru{\der \Gamma \qquad
    }{\Gamma \der \sempty : \cempty}
\qquad
  \ru{\Gamma \der \tau : \Delta \qquad
      \resurrect \Delta \der T \qquad
      \Gamma \der t : T \tau
    }{\Gamma \der \sext \tau t : \cext \Delta T}
\qquad
  \ru{\Gamma \der \tau : \Delta \qquad
      \Gamma \der a : \Size
    }{\Gamma \der \sext \tau a : \eext \Delta \Size}
\end{gather*}

Weakenings \fbox{$\xi : \Gamma \leq \Delta$}  (implies $\der \Gamma$ and $\der \Delta$ and $\Gamma \der \xi : \Delta$).
\begin{gather*}
  \ru{\der \Gamma
    }{\sempty : \Gamma \leq \cempty}
\qquad
  \ru{\xi : \Gamma \leq \Delta \qquad
      \resurrect\Gamma \der T
    }{\xi \slift : \cext \Gamma T \leq \Delta}
\qquad
  \ru{\xi : \Gamma \leq \Delta \qquad
      \resurrect \Delta \der U \qquad
      \resurrect\Gamma \der T \leq U \xi
    }{(\xi \slift, \ind 0) : \cext \Gamma T \leq \cext \Delta U}
\end{gather*}

% Substitution typing. % and equality.
% \fbox{$\Gamma \der \sigma : \Delta$}
% (implies $\der \Gamma$ and $\der \Delta$
%  and $\resurrect\Gamma \der \sigma : \Delta$
%  and $\resurrect\Gamma \der \sigma : \resurrect \Delta$).
% % and
% % \fbox{$\Gamma \der \sigma = \sigma' : \Delta$}.

% \begin{gather*}
%   \ru{\der \Gamma \qquad
%     }{\Gamma \der \sempty : \cempty}
% \qquad
%   \ru{\Gamma \der \sigma : \Delta \qquad
%       \resurrect \Delta \der T \qquad
%       \Gamma \der t : T \sigma
%     }{\Gamma \der \sext \sigma t : \cext \Delta T}
% \qquad
%   \ru{\Gamma \der \sigma : \Delta \qquad
%       \Gamma \der a : \Size
%     }{\Gamma \der \sext \sigma a : \eext \Delta \Size}
% \end{gather*}

% \begin{gather*}
%   \ru{\der \Gamma \qquad
%     }{\Gamma \der \sempty = \sempty : \cempty}
% \qquad
%   \ru{\Gamma \der \sigma = \sigma': \Delta \qquad
%       \resurrect \Delta \der T \qquad
%       \Gamma \der t = t' : T \sigma
%     }{\Gamma \der \sext \sigma t = \sext {\sigma'} t': \cext \Delta T}
% \end{gather*}

% Substitution typing and equality.
% \fbox{$\suty \Gamma \sigma \tau \Delta$} and

Substitution equality
\fbox{$\sueq \Gamma \sigma {\sigma'} \tau \Delta$}
(implies $\der \Gamma$ and $\der \Delta$ and $\Gamma \der \tau : \Delta$ and $\sueq \Gamma {\sigma'} {\sigma} \tau \Delta$).

% \begin{gather*}
%   \ru{\der \Gamma \qquad
%     }{\suty \Gamma \sempty \sempty \cempty}
% \qquad
%   \ru{\suty \Gamma \sigma \tau \Delta \qquad
%       \resurrect \Delta \der T \qquad
%       \Gamma \der u = t : T \tau
%     }{\suty \Gamma {\sext \sigma u} {\sext \tau t} \cext \Delta T}
% \\[2ex]
%   \ru{\suty \Gamma \sigma \tau \Delta \qquad
%       \Gamma \der a = b : \Size
%     }{\suty \Gamma {\sext \sigma a} {\sext \tau b} \cext \Delta \Size}
% \qquad
%   \ru{\suty \Gamma \sigma \tau \Delta \qquad
%       \Gamma \der a, b : \Size
%     }{\suty \Gamma {\sext \sigma a} {\sext \tau b} \erext \Delta \Size}
% \end{gather*}

\begin{gather*}
  \ru{\der \Gamma \qquad
    }{\sueq \Gamma \sempty \sempty \sempty \cempty}
\qquad
  \ru{\sueq \Gamma \sigma {\sigma'} \tau \Delta \qquad
      \resurrect \Delta \der T \qquad
      \Gamma \der u = u' = t : T \tau
    }{\sueq \Gamma {\sext \sigma u } {\sext {\sigma'} {u'}} {\sext \tau t} {\cext \Delta T}}
\\[2ex]
  \ru{\sueq \Gamma \sigma {\sigma'} \tau \Delta \qquad
      \Gamma \der a = a' = b : T \tau
    }{\sueq \Gamma {\sext \sigma a } {\sext {\sigma'} {a'}} {\sext \tau b} {\cext \Delta \Size}}
\qquad
  \ru{\sueq \Gamma \sigma {\sigma'} \tau \Delta \qquad
      \Gamma \der a, a', b : T \tau
    }{\sueq \Gamma {\sext \sigma a } {\sext {\sigma'} {a'}} {\sext \tau b} {\erext \Delta \Size}}
\end{gather*}

\begin{lemma}[Reflexivity]
  If\/ $\Gamma \der t : T$ then $\Gamma \der t = t : T$.
\end{lemma}

In the following, let $J$ %, $L$, and $R$
match a part of a judgement.

\begin{lemma}[Context well-formedness]
\label{lem:cxtwf}\bla
  \begin{enumerate}
  \item If $\der \cext \Gamma \Delta$ then $\der \Gamma$
  \item If\/ $\Gamma \der J$ then $\der \Gamma$.
  \end{enumerate}
\end{lemma}

\begin{lemma}[Resurrection]
\label{lem:res} \bla
\begin{enumerate}
\item $\der \Gamma$ iff $\der \resurrect\Gamma$;  then $\resurrect \Gamma \der \sid : \Gamma$.
  % Consequently, if\/ $\Gamma \der J$ then $\resurrect \Gamma \der J$.
  % Further, if $\Gamma \der J : \resurrect\Delta$ then $\Gamma \der J : \Delta$.
\item If\/ $\Gamma \der J$ then $\resurrect \Gamma \der J$.
\item If\/ $\Gamma \der J : \resurrect \Delta$ % and $\der \Delta$
  then $\Gamma \der J : \Delta$.
\item If\/ $\Gamma \der \sigma : \Delta$ then $\Gamma \der \sigma : \resurrect\Delta$.
% then $\resurrect\Gamma \der \sigma : \resurrect\Delta$.
\end{enumerate}
\end{lemma}

\begin{lemma}[Substitution]
\label{lem:sub}\bla
  If\/ $\Gamma \der \sigma : \Delta$ and $\Delta \der J$ then $\Gamma \der J\sigma$.
\end{lemma}

\begin{lemma}[Specific substitutions]
\label{lem:specsub}\bla
\begin{enumerate}
\item If $\der \cext \Gamma \Delta$ then $\cext \Gamma \Delta \der \slift_{|\Gamma|}^{|\Delta|} : \Gamma$.
      If $\der \cext \Gamma T$ then $\cext \Gamma T \der \slift : \Gamma$.
\item If $\der \Gamma$ then $\Gamma \der \sid : \Gamma$.
\item If $\Gamma \der u : U$ then $\Gamma \der \sg u : \cext \Gamma U$.
\end{enumerate}
\end{lemma}

\begin{lemma}[Substitution equality]
\label{lem:subeq}\bla
\begin{enumerate}
\item Conversion: If\/ $\sueq \Gamma \sigma {\sigma'} {\tau_1} \Delta$ and $\sueq {\resurrect\Gamma} {\tau_1} {\tau_2} {\tau} {\resurrect\Delta}$ then $\sueq \Gamma \sigma {\sigma'} {\tau_2} \Delta$.
\item Reflexivity: If\/ $\Gamma \der \sigma : \Delta$ then $\sueq \Gamma \sigma \sigma \sigma \Delta$.
\item Symmetry:  If\/ $\sueq \Gamma \sigma {\sigma'} {\tau} \Delta$ then $\sueq \Gamma {\sigma'} {\sigma} {\tau} \Delta$.
\item Transitivity:  If\/ $\sueq \Gamma {\sigma_1} {\sigma_2} {\tau} \Delta$ and $\sueq \Gamma {\sigma_2} {\sigma_3} {\tau} \Delta$ then $\sueq \Gamma {\sigma_1} {\sigma_3} {\tau} \Delta$.
\item Functionality: Let $\sueq \Gamma \sigma {\sigma'} \tau \Delta$.
  \begin{enumerate}
  \item
  If $\Delta \der t : T$ then $\Gamma \der t\sigma = t\sigma' : T\tau$.
  \item
  If $\Delta \der t = t' : T$ then $\Gamma \der t\sigma = t'\sigma' : T\tau$.
  \item
  Corollary: If $\Delta \der T \leq T'$ then $\Gamma \der T\sigma \leq T\sigma'$.
  \end{enumerate}
\end{enumerate}
\end{lemma}

\begin{lemma}[Inversion of typing]
\label{lem:invty} \bla
\begin{enumerate}
\item TODO
\end{enumerate}
\end{lemma}




\section{Semantics}
\label{sec:sem}

We extend the syntax by de Bruijn levels $\lev k$
to be used as generic values (unknowns) and type annotations
$\up T t$ and $\down T t$ for lazy realisations of the
reflection and reification operations of NbE.
\[
\begin{array}{lllrl@{\qquad}l}
%  \Exp  & \ni & t & ::= & \dots \mid \lev k \mid \up T t \mid \down T t \\
  \Ne   & \ni & n & ::= & \dots \mid \lev k \\
  \tUp  & \ni & N & ::= & \up T n \\
  \Whnf & \ni & w & ::= & \dots \mid N \\
  \tDown & \ni & d & ::= & \down T t \\
  \Exp  & \ni & t & ::= & \dots \mid d \\
%  \Whnf & \ni & w,d,f,g,A,B,F,G & ::= & \dots \mid  \up T n \mid \down T t \\
\end{array}
\]


\begin{figure}
$$
\xymatrix@R=12ex@C=12ex{
\mathrlap{\mbox{Semantics ($\beta$)}} &
  &                f \in \D   \ar@[red][d]_{\down A}
\\
\mathrlap{\mbox{Semantics ($\beta\eta$)}} &
  &                d \in \DNf \ar@[red][d]_{\tR_k{}}
  &                n \in \DNe \ar[d]_{\tRne_k} \ar@[blue][ul]_{\up A}
  & \ar@[blue][l]_{\var{}} j \in \Level \ar@{<->}[d]_{k\dotminus(1+\_)}
\\
\mathrlap{\mbox{Syntax}} &
t \in \Exp \ar@[red]@(u,dl)[uur]^{\_\color{blue}\eta} %\ar@/^/[uur]^{\den\_}
  & \ar[l]_{\supseteq}  v \in \Nf
  & \ar[l]_{\supseteq}  m \in \Ne
  & \ar[l]_{\ind{}}     i \in \Index
  &
}
$$
\caption{Type-assignment NbE in locally nameless
    style.\label{fig:typedchart}}
\end{figure}

Figure~\ref{fig:typedchart}, adapted from \citet{abel:habil} shows the syntactic categories and main operations involved in NbE in what we call \emph{locally nameless style}.  The red path $\Exp \to \D \to \Dnf \to \Nf$ decomposes $\beta\eta$-normalization into three steps.
\begin{enumerate}
\item
First, we close the term $t$ with an environment $\eta$ that maps the free de Bruijn indices of $t$ to reflected de Bruijn levels.  Reflection of de Bruijn levels follows the blue path $\Level \to \Dne \to \D$: Levels embed via constructor $\var{}$ into semantic neutrals $\DNe$ which are labelled with their type $A \in \D$ to become and element $\up A \lev j \in \D$.

\item
Then, we label value $t \eta \in \D$ with its type $A$ to obtain $\down A t \eta \in \Dnf$.
\item
Finally, \emph{read back} %% $\tR_k$
$\tR_k \down{A} t\eta$ produces a long normal form $v \in \Nf$, converting de Bruijn levels back to indices.
Herein, $k$ should be the length of the context the original term $t$ lived in.
If this is the case, each de Bruijn level encountered during read back is below $k$ and can be safely converted to a de Bruijn index.
\end{enumerate}

\subsection{Operational semantics}

Judgements.
\[
\begin{array}{l@{\qquad}l}
  t \evalsto w & \mbox{term $t$ evaluates to weak head normal form $w$} \\
  w @ e \evalsto w' & \mbox{eliminating $w$ with $e$ evaluates to $w'$} \\
%  w @ \vec e \evalsto w' & \mbox{applying $w$ to eliminations $\vec e$ evaluates to $w'$} \\
\end{array}
\]

\fbox{$t \evalsto w$}
\begin{gather*}
  \ru{}{w \evalsto w}
\qquad
  \ru{t \evalsto w \qquad w @ e \evalsto w'}{t\,e \evalsto w'}
\end{gather*}

% \fbox{$w @ \vec e \evalsto w'$}
% \begin{gather*}
%   \ru{}{w @ () \evalsto w}
% \qquad
%   \ru{w @ e \evalsto w' \qquad
%       w' @ \vec e \evalsto w''
%     }{w @ (e, \vec e) \evalsto w''}
% \end{gather*}

\fbox{$w @ e \evalsto w'$}
\begin{gather*}
  \ru{t[u] \evalsto w
    }{(\lambda t) @ u \evalsto w}
\qquad
  \ru{t[\alpha] \evalsto w
    }{(\lambda t) @ \alpha \evalsto w}
\qquad
  \ru{t[\alpha] \evalsto w
    }{(\lambda t) @ \ann \alpha \evalsto w}
\\[2ex]
  \ru{t_z \evalsto w
    }{(\zero \alpha) @ \casett \evalsto w}
\qquad
  \ru{t_s\, t \evalsto w
    }{(\suc \alpha t) @ \casett \evalsto w}
\\[2ex]
  \ru{t\,\ann \alpha\,(\lambda x.\, x@ \fixtt)\,c \evalsto w
     }{c @ \fixtt \evalsto w
     }{c\in \{ \zero \alpha, \suc \alpha u \}}
\end{gather*}
The rules added for NbE deal with elimination of delayed reflection:
\begin{gather*}
  \ru{T' \evalsto \piT U T
    }{(\up {T'} n) @ u \evalsto \up{T[u]} (n \, \down U u) }
\qquad
  \ru{T' \evalsto \piT \Size T
    }{(\up {T'} n) @ \alpha \evalsto \up{T[\alpha]} (n \, \alpha)}
\qquad
  \ru{T' \evalsto \forallT T
    }{(\up {T'} n) @ \ann \alpha \evalsto \up{T[\alpha]} (n \ann \alpha)}
%   \ru{T \evalsto \piT A B \qquad
%       \up{B[u]} (n \, \down A u) \evalsto w
%     }{(\up T n) @ u \evalsto w}
% \qquad
%   \ru{T \evalsto \piT \Size B \qquad
%       \up{B[u]} (n \, \alpha) \evalsto w
%     }{(\up T n) @ \alpha \evalsto w}
% \qquad
%   \ru{T \evalsto \forallT B \qquad
%       \up{B[\alpha]} (n \ann \alpha) \evalsto w
%     }{(\up T n) @ \ann \alpha \evalsto w}
\\[2ex]
  \ru{T' \evalsto \Nat \beta \qquad
    }{(\up {T'} n) @ \case[\ell] T {t_z} {t_s} \evalsto
      \up{T\,(\up{\Nat \infty} n)}
         n\,\case[\ell]
             T %% {(\down {\Set[\infty]} T)}
             {(\down {T\,{\zero\infty}} t_z)}
             {(\down {\funS x {\Nat \infty} T\,(\suc \infty x)} t_s)}
    }
\\[2ex]
  \ru{T' \evalsto \Nat \beta \qquad
    }{(\up {T'} n) @ \fix[\ell] T t \evalsto
      n\,\fix[\ell] {(\down {\FixK} T)} {(\down {\FixT\, T} t)}
    }
\end{gather*}

\subsection{Read back}
\label{sec:read}

Judgements.
\[
\begin{array}{l@{\qquad}l}
   \R k d  v     & \mbox{} \\
   \RTy k T  V  & \mbox{} \\
   \RNat k t  v & \mbox{} \\
   \RNe k t  m  & \mbox{} \\
\end{array}
\]
\fbox{$\R k d v$}
\begin{gather*}
  \ru{U \evalsto s \qquad
      \RTy k T V
    }{\R k {\down{U} T} V}
\qquad
  \ru{U \evalsto \Nat \alpha \qquad
      \RNat k u v
    }{\R k {\down{U} u} v}
\qquad
  \ru{U \evalsto N \qquad
      \RUp k u m
      % u \evalsto \up{T} n \qquad \RNe k n m
    }{\R k {\down{U} u} m}
\\[2ex]
  \ru{U \evalsto \piT A B \qquad
      \R{k+1} {\down{B[\up A \lev k]} (f\,\up A \lev k)} v
    }{\R k {\down{U} f} {\lambda v}}
\\[2ex]
  \ru{U \evalsto \piT \Size B \qquad
      \R{k+1} {\down{B[\lev k]} (f\,\lev k)} v
    }{\R k {\down{U} f} {\lambda v}}
\qquad
  \ru{U \evalsto \forallT B \qquad
      \R{k+1} {\down{B[\lev k]} (f\,\ann{\lev k})} v
    }{\R k {\down{U} f} {\lambda v}}
\end{gather*}

\fbox{$\RUp k t m$}\ \  Read back neutrals under annotation, which is ignored.
\begin{gather*}
  \ru{t \evalsto \up T n \qquad
      \RNe k n m
    }{\RUp k t m}
\end{gather*}

\fbox{$\RNat k t v $}
\begin{gather*}
  \ru{% t \evalsto \up {\Nat \alpha} n \qquad
      %t \evalsto \up {T} n \qquad \RNe k n m
      \RUp k t m
    }{\RNat k t m}
\qquad
  \ru{t \evalsto \zero{\alpha} \qquad
      \RSize k {\alpha} a
    }{\RNat k t {\zero a}}
\qquad
  \ru{t \evalsto \suc{\alpha}u \qquad
      \RSize k {\alpha} a \qquad
      \RNat k u v
    }{\RNat k t {\suc a v}}
\end{gather*}

\fbox{$\RSize k {\alpha} a$}
\begin{gather*}
  \ru{
    }{\RSize k \infty \infty}
\qquad
  \ru{
    }{\RSize k o o}
\qquad
  \ru{
    }{\RSize k {\lev j + o} {\ind{k\dotminus(1+j)} + o}}
\end{gather*}

\fbox{$\RNe k n m$} and \fbox{$\RElim k e e^v$}
\begin{gather*}
%   \ru{t \evalsto \lev j
%     }{\RNe k t {\ind{k-1-j}}}
% \qquad
  \ru{%t \evalsto \lev j\,\vec e \qquad
      \RElim k {e_i} {e^v_i} \mforall i
    }{\RNe k {\lev j\,\vec e} {\ind{k \monus (1+j)}\,\vec e^v}}
\qquad
% \end{gather*}
% \begin{gather*}
  \ru{\R k d v
    }{\RElim k d v}
\qquad
  \ru{\RSize k \alpha b
    }{\RElim k \alpha b}
\qquad
  \ru{\RSize k \alpha b
    }{\RElim k {\ann \alpha} {\ann b}}
\\[2ex]
  \ru{\RTy k T V \qquad
      \R k {d_z} {v_z} \qquad
      \R k {d_s} {v_s}
    }{\RElim k {(\case[\ell] T {d_z} {d_s})} {\case[\ell] V {v_z} {v_s}}}
\qquad
  \ru{\RTy k T V \qquad
      \R k d v
    }{\RElim k {(\fix[\ell] T d)} {\fix[\ell] V v}}
\end{gather*}
\fbox{$\RTy k T V$}
\begin{gather*}
  \ru{T \evalsto \Set[\ell]
    }{\RTy k T {\Set[\ell]}}
\qquad
  \ru{T \evalsto \Nat \alpha \qquad
      \RSize k \alpha b
    }{\RTy k T {\Nat b}}
\qquad
  \ru{% T \evalsto \up{U}n \qquad \RNe k n m
      \RUp k T m
    }{\RTy k T m}
\\[2ex]
  \ru{T \evalsto \piT A B \qquad
      \RTy k A {V_a} \qquad
      \RTy {k+1} B {V_b}
    }{\RTy k T {\piT {V_a} V_b}}
\qquad
  \ru{T \evalsto \epiT \Size B \qquad
      \RTy {k+1} B {V}
    }{\RTy k T {\epiT \Size V}}
\end{gather*}

We write \fbox{$t \approx t'$} iff $t$ and $t'$ are syntactically equal if we ignore sizes $\ann a$ in irrelevant positions.  For example, $\suc a \tzero \approx \suc 0 \tzero$, but $\Nat a \not\approx \Nat 0$.



\subsection{Partial equivalence relations}
\label{sec:per}

A type $T$ will be interpreted as a partial equivalence relation (PER) $\A$ on terms, \ie, a relation which is symmetric and transitive. The domain $\dom(\A)$ of the relation can be thought of the set of terms which define the extension of the type; on $\dom(\A) = \{a \mid \exists a'.\ (a,a') \in \A \}$ the relation $\A$ is in fact an equivalence relation.  We write $a = a' \in \A$ for relatedness in $\A$ and $a \in \A$ if $a \in \dom(\A)$.

The PERs $\NE$ characterizes neutral reifyable terms.
% \[
% \begin{array}{lll}%{l@{\quad}l@{\quad}l@{~}l@{~}l@{~}l@{~}l@{~}l}
%   \fbox{$\up T n = \up {T'} {n'} \in \NE$}
%     & \defas &
%     T \evalsto N \mand T' \evalsto N' \mand
%     \mforall k \mboth
%     \RNe k n m \mand \RNe k {n'} {m'} \mand m \approx m'
%     .\\
% \end{array}
% \]
The PERs $\NE$ and $\NF$ characterize (neutral) normalizing terms.
\[
\begin{array}{l@{\quad}l@{\quad}l@{~}l@{~}l@{~}l@{~}l@{~}l}
  \fbox{$n = n' \in \NE$}
    & \defas &
    \RNe k n m &\mand& \RNe k {n'} {m'} &\mand& m \approx m' &\mforall k \\
  \fbox{$d = d' \in \NF$}
    & \defas &
    \R k d v &\mand& \R k {d'} {v'} &\mand& v \approx v' &\mforall k \\
\end{array}
  % \ru{\RNe k t m \mand \RNe k {t'} {m'} \mand m \approx m' \mforall k
  %   }{t = t' \in \NE}
  % \ru{t \evalsto \up N n \qquad t' \evalsto \up{N'}{n'} \qquad n \approx n'
  %   }{t = t' \in \NE}
\]
%All PERs $\A$ we consider are sandwiched $\NE \subseteq \A \subseteq \NF$ between $\NE$ and $\NF$.

\begin{lemma}[Closure properties of $\NE$ and $\NF$]
  \bla
  \begin{enumerate}
  \item $\lev k = \lev k \in \NE$.
  \item If $n = n' \in \NE$ and $d = d' \in \NF$ then $n\,d = n'\,d' \in \NE$.
%  \item If $d = d' \in \NF$
  \end{enumerate}
\end{lemma}

Neutrals in the value world $\D$.
\[
\fbox{$t = t' \in \NEE$} \defas
  t \evalsto \up T n \mand t' \evalsto \up{T'}{n'} \mand
  n = n' \in \NE
% \fbox{$\NEE$} \defas \{ (\up T n, \up{T'}{n'})
%   % \msuchthat T \evalsto N \mand T' \evalsto N' \mand
%   \mid n = n' \in \NE \}
\]
\fbox{$\NAT(\alpha)$}
\begin{gather*}
  \ru{% t \evalsto \up{\Nat \alpha} n \qquad
      % t' \evalsto \up{\Nat \alpha'} n' \qquad
      % n = n' \in \NE
      t = t' \in \NEE
    }{t = t' \in \NAT(\beta)}
\qquad
  \ru{t \evalsto \zero \alpha \qquad
      t' \evalsto \zero{\alpha'}
    }{t = t' \in \NAT(\beta+1)}
\qquad
  \ru{t \evalsto \suc \alpha u \qquad
      t' \evalsto \suc {\alpha'} {u'} \qquad
      u = u' \in \NAT(\beta)
    }{t = t' \in \NAT(\beta+1)}
\end{gather*}

\fbox{$\SIZE$} is a discrete PER of size values:
\begin{gather*}
  \ru{
    }{\infty = \infty \in \SIZE}
\qquad
  \ru{
    }{o = o \in \SIZE}
\qquad
  \ru{
    }{\lev k + o = \lev k + o \in \SIZE}
\end{gather*}

Let $\A$ be a PER and $\F$ a family of PERs over $\A$ such that
$\F(u) = \F(u')$ whenever $u = u' \in \A$.  We define
\[
  \fbox{$\PIAF$} \defas \{(t,t') \mid t\,u = t'\,u' \in \F(u) \mforall u = u' \in \A \}
  .
\]
This works also for $\A = \SIZE$.
For a family $\F$ over $\SIZE$ we also have the irrelevant function space
\[
  \fbox{$\FORALL\,\F$} \defas
  \{(t,t') \mid t \ann \alpha = t' \ann{\alpha'} \in \F(\beta) \mforall \alpha,\alpha',\beta \in \SIZE \}
  .
\]

% \begin{lemma}[PER Subsumption]
% \label{lem:subsump} \hfill
% \begin{enumerate}
% \item If $\alpha \leq \beta$ then $\NAT(\alpha) \subseteq \NAT(\beta)$.
% \item If $\F(\alpha) \leq \F'(\alpha)$ for all $\alpha \in \SIZE$, then $\FORALL \F \subseteq \FORALL \F'$.
% \item IF $\A' \subseteq \A$ and $\F(u) \subseteq \F'(u)$ for all $u \in \A'$, then $\PIAF \subseteq \PI\,\A'\,\F'$.
% \end{enumerate}
% \end{lemma}



\subsection{PER model}
\label{sec:permode}

By induction on $\ell \in \NN$ we define the PER family
$\_ = \_ \in \Set[\ell]$ of types
together with the extension $\EL[\ell] T$ (for $T = T' \in \Set[\ell]$)
which is PER of values of type $A$.
The rules for \fbox{$T = T' \in \SET[\ell]$} are:
\[
\begin{array}{l@{\qquad}l}
  \ru{% T \evalsto \up{\Set[\ell']} n \qquad
      % T' \evalsto \up{\Set[\ell'']} n' \qquad
      % n = n' \in \NE
      T = T' \in \NEE
    }{T = T' \in \SET[\ell]}
  & \EL[\ell](T) = \NEE
\\[3ex]
  \ru{T \evalsto \Nat\,\alpha \qquad T' \evalsto \Nat\,\alpha
    }{T = T' \in \SET[\ell]}
  & \EL[\ell](T) = \NAT(\alpha)
\\[3ex]
  \rux{T \evalsto \Set[\ell'] \qquad T' \evalsto \Set[\ell']
     }{T = T' \in \SET[\ell]
     }{\ell'{<}\ell}
  & \EL[\ell](T) = \SET[\ell']
\\[3ex]
  \rul{T \evalsto \piT A B \qquad
      T' \evalsto \piT{A'}{B'} \\
      A = A' \in \SET[\ell] \qquad
      B[u] = B'[u'] \in \SET[\ell] \mforall u = u' \in \EL[\ell](A)
    }{T = T' \in \SET[\ell]}
  & \EL[\ell](T) = \PI(\EL[\ell](A),\;u \mapsto \EL[\ell](B[u]))
\\[3ex]
  \rul{T \evalsto \piT \Size B \quad
      T' \evalsto \piT{\Size}{B'} \quad
      B[\alpha] = B'[\alpha] \in \SET[\ell] \mforall \alpha \in \SIZE
    }{T = T' \in \SET[\ell]}
  & \EL[\ell](T) = \PI(\SIZE,\; \alpha \mapsto \EL[\ell](B[\alpha]))
\\[3ex]
  \rul{T \evalsto \forallT B \quad
      T' \evalsto \forallT{B'} \quad
      B[\alpha] = B'[\alpha] \in \SET[\ell] \mforall \alpha \in \SIZE
    }{T = T' \in \SET[\ell]}
  & \EL[\ell](T) = \FORALL(\alpha \mapsto \EL[\ell](B[\alpha]))
\end{array}
\]
All relations involved here are closed under weak head expansion.
\begin{lemma}[Well-definedness]
  Let $\DD :: T_1 = T_2 \in \SET[\ell]$.
  \begin{enumerate}
  \item Symmetry: $T_2 = T_1 \in \SET[\ell]$.
  \item Transitivity: If $T_2 = T_3 \in \SET[\ell]$ then $T_1 = T_3 \in \SET[\ell]$.
  \item Extension: $\EL[\ell](T_1) = \EL[\ell](T_2)$ and ``both'' are PERs.
  \end{enumerate}
\end{lemma}
\begin{proof}
  Simultaneously by induction on $\DD$.
\end{proof}

% The PER model has the usual properties, one of them being that $\EL[\ell](T)$ does not depend $\ell$ nor the derivation that introduced $T = T' \in \SET[\ell]$.  Thus, we simply write $t = t' \in \EL(T)$ or even $t = t' \in T$.
\begin{lemma}[Derivation independence of extension]
\label{lem:indep}
  If $\DD_1 :: T = T_1 \in \SET[\ell_1]$
  and $\DD_2 :: T_2 = T \in \SET[\ell_2]$ then $\EL[\ell_1](T) = \EL[\ell_2](T)$.
\end{lemma}
\begin{proof}
  By induction on $\DD_1$ and cases on $\DD_2$.
\end{proof}
Sine $\EL[\ell](T)$ does not depend $\ell$ nor the derivation that introduced $T = T' \in \SET[\ell]$,  we may simply write $t = t' \in \EL(T)$ or even $t = t' \in T$.


\subsection{Subtyping}
\label{sec:subty}

The semantic types (PERs) admit subsumption:

\begin{lemma}[Subsumption]
\label{lem:subsump} \hfill
\begin{enumerate}
\item \label{it:natsub} If $\alpha \leq \beta$ then $\NAT(\alpha) \subseteq \NAT(\beta)$.
\item \label{it:allsub} If $\F(\alpha) \leq \F'(\alpha)$ for all $\alpha \in \SIZE$, then $\FORALL \F \subseteq \FORALL \F'$.
\item \label{it:pisub}  If $\A' \subseteq \A$ and $\F(u) \subseteq \F'(u)$ for all $u \in \A'$, then $\PIAF \subseteq \PI\,\A'\,\F'$.
\item \label{it:usub}  If $\ell \leq \ell'$ then $\SET[\ell] \subseteq \SET[\ell']$.
\end{enumerate}
\end{lemma}
\begin{proof}
  Propositions (\ref{it:natsub}--\ref{it:pisub}) are clear.
  For (\ref{it:usub}), prove $T = T' \in \SET[\ell']$ by induction on $T = T' \in \SET[\ell]$.
  For the base types this is direct, let us look at the function space.
\[
  \rul{T \evalsto \piT A B \qquad
      T' \evalsto \piT{A'}{B'} \qquad
      A = A' \in \SET[\ell] \qquad
      B[u] = B'[u'] \in \SET[\ell] \mforall u = u' \in \EL[\ell](A)
    }{T = T' \in \SET[\ell]}
\]
  By induction hypothesis, $A = A' \in \SET[\ell']$, and we have $\EL[\ell'](A) = \EL[\ell](A)$ by Lemma~\ref{lem:indep}.  Assuming $u = u' \in \EL(A)$, we get $B[u] = B'[u'] \in \SET[\ell']$ by induction hypothesis on $B[u] = B'[u'] \in \SET[\ell]$.
\end{proof}
We can define subtyping of type values \fbox{$T \leq T'$} by induction on $T \in \SET[\ell]$ and $T' \in \SET[\ell']$.
Simultaneously, we need to prove correctness, namely that $T \leq T'$ implies $\EL(T) \subseteq \EL(T')$.  The correctness follows from Lemma~\ref{lem:subsump} and we do not spell it out here.
\begin{gather*}
  \ru{T = T' \in \NEE
    }{T \leq T'}
\qquad
  \ru{T \evalsto \Nat \alpha \qquad
      T' \evalsto \Nat \alpha' \qquad
      \alpha \leq \alpha'
    }{T \leq T'}
\qquad
  \ru{T \evalsto \Set[\ell_0] \qquad
      T' \evalsto \Set[\ell_0'] \qquad
      \ell_0 \leq \ell_0'
    }{T \leq T'}
\\[2ex]
  \ru{T \evalsto \piT A B \qquad
      T' \evalsto \piT {A'}{B'} \qquad
      A' \leq A \qquad
      B[u] \leq B'[u'] \mforall u = u' \in A'
    }{T \leq T'}
\\[2ex]
  \ru{T \evalsto \epiT \Size B \qquad
      T' \evalsto \epiT {\Size}{B'} \qquad
      B[\alpha] \leq B'[\alpha] \mforall \alpha \in \SIZE
    }{T \leq T'}
\end{gather*}
\begin{lemma}[Subtyping is preorder]
\label{lem:preord}
\bla
\begin{enumerate}
\item If\/ $T = T' \in \SET[\ell]$ then $T \leq T'$.
\item If\/ $T_1 \leq T_2$ and $T_2 \leq T_3$ then $T_1 \leq T_3$.
\end{enumerate}
\end{lemma}


% \begin{lemma}[Universe subsumption]
%   \label{lem:usubsump}
%   If $\ell \leq \ell'$ then $\SET[\ell] \subseteq \SET[\ell']$.
% \end{lemma}
% \begin{proof}
%   Prove $T = T' \in \SET[\ell']$ by induction on $T = T' \in \SET[\ell]$.
%   For the base types this is direct, let us look at the function space.
% \[
%   \rul{T \evalsto \piT A B \qquad
%       T' \evalsto \piT{A'}{B'} \qquad
%       A = A' \in \SET[\ell] \qquad
%       B[u] = B'[u'] \in \SET[\ell] \mforall u = u' \in \EL[\ell](A)
%     }{T = T' \in \SET[\ell]}
% \]
%   By induction hypothesis, $A = A' \in \SET[\ell']$, and we have $\EL[\ell'](A) = \EL[\ell](A)$ by Lemma~\ref{lem:indep}.  Assuming $u = u' \in \EL(A)$, we get $B[u] = B'[u'] \in \SET[\ell']$ by induction hypothesis on $B[u] = B'[u'] \in \SET[\ell]$.
% \end{proof}



\subsection{Type shapes}
\label{sec:shape}

Reflection and reification perform $\eta$-expansion such that we arrive at an $\eta$-long $\beta$-normal form.  To perform the $\eta$-expansion, not the precise type is needed, just the approximate shape, in particular, whether it is a function type (do expand) or a base type (do not expand).
For the logical framework, the shape of a dependent type is just its underlying simple type \cite{harperPfenning:equivalenceLF}. However, in the presence of universes and large eliminations, there is no underlying simple type.  Of course, we can take a type as its own shape, but we want at least that $\Nat \alpha$ and $\Nat \beta$ have the same shape even for different $\alpha, \beta$.  Thus, we define a relation $T \shape S$ to express that $S$ is a possible shape of type $T$.

\fbox{$T \shape S$} for $T \in \SET[\ell]$.  We call $T$ the \emph{template} and $S$ one of its possible \emph{shapes}.
\begin{gather*}
  \ru{T \evalsto \Nat \alpha \qquad
      S \evalsto \Nat \beta
    }{T \shape S}
\qquad
  \ru{T \evalsto N \qquad
      S \evalsto N'
    }{T \shape S}
\qquad
   \ru{T \evalsto \Set[\ell] \qquad
       S \evalsto \Set[\ell]
    }{T \shape S}
\\[2ex]
  \ru{T \evalsto \piT A B \qquad
      S \evalsto \piT{A'}{B'} \qquad
      A \shape A' \qquad
      B[u] \shape B'[u'] \mforall u = u' \in A
    }{T \shape S}
\\[2ex]
  \ru{T \evalsto \piT \Size B \qquad
      S \evalsto \piT{\Size}{B'} \qquad
      B[\alpha] \shape B'[\alpha] \mforall \alpha \in \SIZE
    }{T \shape S}
\\[2ex]
  \ru{T \evalsto \forallT B \qquad
      S \evalsto \forallT{B'} \qquad
      B[\alpha] \shape B'[\alpha'] \mforall \alpha,\alpha' \in \SIZE
    }{T \shape S}
\end{gather*}
% The last rule is the crucial one

Note that $T \in \SET[\ell]$ and $T \shape S$ do not imply $S \in \SET[\ell]$.
Type shapes are not well-defined types in general.
For instance, assume a term $F : \Nat 0 \to \Set[0]$ which diverges if applied to a successor term.
Then $T := \funT x {\Nat 0} {F\,x}$ is a welldefined type; we have $T \in \SET[0]$.
Now consider $S := \funT x {\Nat \infty} {F\,x}$.
We have $T \shape S$, but not $S$ is not well-defined; $S \not\in \SET[0]$.
% $\funT x {\Nat 0} {F\,x} \shape , but the latter one is not a well-defined type.

\begin{lemma}[Types are their own shapes]
  If\/ $T = T' \in \SET[\ell]$ then $T \shape T'$.
\end{lemma}

\begin{lemma}[Equal types make equally good templates]
  If\/ $T = T' \in \SET[\ell]$ and $T' \shape S$ then $T \shape S$.
\end{lemma}

However, templates are not closed under subtyping in either direction because of contravariance.

Further, it is not true that equal types make equally good shapes.  We do not have that
$T \shape S$ and $S = S' \in \SET[\ell]$ imply $T \shape S'$.  This property fails for function types.
Given $\piT U T \shape \piT R S$ and $\piT R S = \piT {R'}{S'} \in \SET[\ell]$ we would need to show that $T[u] \shape S'[u']$ for all $u = u' \in U$, but we only have $S[u] = S'[u'] \in \SET[\ell]$ for all $u = u' \in R$, thus the induction does not go through.  The fact that $U \shape R$ does not give us a handle on their inhabitants, we would need $U \leq R$.
It is possible to construct an actual counterexample, using
$\piT {R'} S' =  \funT x {\Nat 0} {F\,x}$ from above and $\piT R S = \funT x {\Nat 0} {G\,x}$
such that $G$ is defined on all of $\Nat \infty$ but agrees with $F$ only on $x \in \Nat 0$.
Then $\piT U T = \funT x {\Nat \infty} {G\,x}$ gives the desired counterexample.

% Note that while such examples exist in the semantics, they probably do not exist in the syntax (where no well-typed term is diverging).  However, it is not clear to us how to define

% %% WRONG
% \begin{lemma}[Subtypes are valid templates]
%   Let $T \in \SET[\ell]$ and $T' \in \SET[\ell']$.
%   If\/ $T \leq T'$ and $T' \shape S'$ then $T \shape S'$.
% \end{lemma}
% \begin{proof}
% By induction on the derivations.
% \begin{caselist}

% \nextcase $T \evalsto \piT A B$ and $T' \evalsto \piT{A'}{B'}$ and $T' \evalsto \piT R S$.
% \\
% We have $A \shape R$ by induction hypothesis on $A' \leq A$ and $A' \shape R$.  No!
% \end{caselist}
% \end{proof}

Shapes are used to direct $\eta$-expansion when we reflect neutrals into semantic types and reify semantic values to long normal forms.  The following theorem is the heart of our technical development.

\begin{theorem}[Reflection and reification]
Let $T \in \SET[\ell]$ and $T \shape S_1$ and $T \shape S_2$.
\begin{enumerate}
\item If $n_1 = n_2 \in \NE$ then $\up{S_1}{n_1} = \up{S_2}{n_2} \in T$.
\item If $t_1 = t_2 \in T$ then $\down{S_1}{t_1} = \down{S_2}{t_2} \in \NF$.
\end{enumerate}
\end{theorem}
\begin{proof}
By induction on $T \in \SET[\ell]$ and cases on $T \shape S_1$ and $T \shape S_2$.
\begin{caselist}

\nextcase $T \evalsto \piT A B$
\begin{gather*}
  \ru{A \in \SET[\ell] \qquad
      B[u] = B[u'] \in \SET[\ell] \mforall u = u' \in A
    }{T \in \SET[\ell]}
\\[2ex]
  \ru{S_1 \evalsto \piT{A_1}{B_1} \qquad
      A \shape A_1 \qquad
      B[u] \shape B_1[u'] \mforall u = u' \in A
    }{T \shape S_1}
\\[2ex]
  \ru{S_2 \evalsto \piT{A_2}{B_2} \qquad
      A \shape A_2 \qquad
      B[u] \shape B_2[u'] \mforall u = u' \in A
    }{T \shape S_2}
\end{gather*}
\begin{enumerate}
\item To show $\up{S_1}{n_1} = \up{S_2}{n_2} \in T$ assume arbitrary $u_1 = u_2 \in A$.
  Let $d_i = \down{A_i}{u_i}$.
  By induction hypothesis, $d_1 = d_2 \in \NF$.
  Thus, $n_1\,d_1 = n_2\,d_2 \in \NE$, and
  by induction hypothesis,  $\up{B_1[u_1]}(n_1\,d_1) = \up{B_2[u_2]}(n_2\,d_2) \in B[u_1]$.
  With $(\up{S_i}{n_i})\,u_i \evalsto \up{B_i[u_i]}(n_i\,d_i)$ we are done by definition of $\EL(T)$.

\item We assume $k \in \NN$ and show $\R k {\down{S_i}{t_i}} \lambda v_i$ for some normal forms
$v_1,v_2$.  Let $u_i = \up{A_i} \lev k$.  Note that $u_1 = u_2 \in A$ by induction hypothesis.
It is sufficient to show
$\R{k+1}{\down{B_i[u_i]}{(t_i\,u_i)}} {v_i}$.
By definition of $\EL(T)$ we have $t_1\,u_1 = t_2\,u_2 \in B[u_1]$, thus, by induction hypothesis,
$\down{B_1[u_1]}(t_1\,u_1) = \down{B_2[u_2]}(t_2\,u_2) \in \NF$, which delivers $v_1$ and $v_2$ for $k+1$.
\end{enumerate}

\nextcase $T \evalsto \forallT B$
\begin{gather*}
  \ru{B[\alpha] \in \SET[\ell] \mforall \alpha \in \SIZE
    }{T \in \SET[\ell]}
\\[2ex]
  \ru{S_1 \evalsto \forallT{B_1} \qquad
      B[\alpha] \shape B_1[\alpha'] \mforall \alpha, \alpha' \in \SIZE
    }{T \shape S_1}
\\[2ex]
  \ru{S_2 \evalsto \forallT{B_2} \qquad
      B[\alpha] \shape B_2[\alpha'] \mforall \alpha, \alpha' \in \SIZE
    }{T \shape S_2}
\end{gather*}
\begin{enumerate}
\item To show $\up{S_1}{n_1} = \up{S_2}{n_2} \in T$ assume arbitrary $\alpha_1,\alpha_2 \in \SIZE$.
  Since $n_1 \ann{\alpha_1} = n_2 \ann{\alpha_2} \in \NE$, we obtain
  $\up{B_1[\alpha_1]}{(n_1 \ann{\alpha_1})} = \up{B_2[\alpha_2]}{(n_2 \ann{\alpha_2})} \in B[\alpha_1]$
  by induction hypothesis.
  Thus, $(\up{S_1}{n_1}) \ann{\alpha_1} = (\up{S_2}{n_2}) \ann{\alpha_2} \in B[\alpha_1]$
  by weak head expansion, which entails the goal by definition of $\EL(T)$.
\item Assume $k \in \NN$ and note that $\lev k = \lev k \in \SIZE$, hence,
  $t_1\,\ann{\lev k} = t_2\,\ann{\lev k} \in B[\lev k]$.  Thus, by induction hypothesis,
  $\R{k+1}{\down{B_i[\lev k]}(t_i\,\ann{\lev k})}{v_i}$, and finally
  $\R k {\down{S_i} t_i} {\lambda v_i}$ by definition of read back.

\end{enumerate}

\end{caselist}
\end{proof}

\begin{corollary}
  If\/ $T \in \SET[\ell]$ and $t = t' \in T$ then $\down T t = \down T {t'} \in \NF$.
\end{corollary}


\subsection{Fundamental Theorem}
\label{sec:fund}

PER of substitutions
\fbox{$\eta = \eta' \eeq \rho \in \Gamma$}.
\begin{gather*}
  \ru{
    }{\sempty = \sempty \eeq \sempty \in \cempty}
\qquad
  \ru{\eta = \eta' \eeq \rho \in \Gamma \qquad
      T\rho \in \SET[\ell] \qquad
      u = u' = t \in T \rho
    }{\sext \eta u = \sext{\eta'}{u'} \eeq \sext{\rho}{t} \in \cext \Gamma T}
\\[2ex]
  \ru{\eta = \eta' \eeq \rho \in \Gamma \qquad \alpha \in \SIZE
    }{\sext \eta \alpha = \sext{\eta'}{\alpha} \eeq \sext{\rho}{\alpha} \in \cext \Gamma \Size}
\qquad
  \ru{\eta = \eta' \eeq \rho \in \Gamma \qquad \alpha,\alpha',\beta \in \SIZE
    }{\sext \eta \alpha = \sext{\eta'}{\alpha'} \eeq \sext{\rho}{\beta} \in \erext \Gamma \Size}
\end{gather*}
We write $\rho \in \Gamma$ for $\rho = \rho \eeq \rho \in \Gamma$.
\begin{lemma}[Resurrection]
  \label{lem:resenv}
  If $\eta = \eta' \eeq \rho \in \Gamma$ then $\rho \in \resurrect\Gamma$.
\end{lemma}

Semantic judgements:
\[
\begin{array}{l@{\quad}l@{\quad}l}
  \models () & \defas & \mtrue \\
  \models \eext \Gamma \Size & \defas & \models \Gamma \\
  \models \cext \Gamma T     & \defas & \models \Gamma \mand \resurrect\Gamma \models T
\\[2ex]
  \Gamma \models s & \defas & \models \Gamma \\
%  \Gamma \models s & \defas & \mtrue \\
  \Gamma \models T & \defas & \Gamma \models T = T \\
  \Gamma \models T = T' & \defas & \Gamma \models T = T' : s \mforsome s %\Set[\ell] \mforsome \ell
\\[2ex]
  \Gamma \models T \leq T' & \defas & \Gamma \models T \mand \Gamma \models T' \mand
    T\eta \leq T'\eta'
    % \EL(T\eta) \subseteq \EL(T'\eta')
    \mforall \eta = \eta' \eeq \rho \in \Gamma
\\[2ex]
  \Gamma \models t : T & \defas & \Gamma \models t = t : T \\
  \Gamma \models t = t' : T & \defas & %\models \Gamma \mand
    % \resurrect\Gamma \models T \mand
    \models \cext \Gamma T \mand
    t \eta = t' \eta' \in T \rho \mforall \eta = \eta' \eeq \rho \in \Gamma
\\[2ex]
  \Gamma \models \sigma : \Delta & \defas & \Gamma \models \sigma = \sigma \eeq \sigma : \Delta \\
  \Gamma \models \sigma = \sigma' \eeq \tau : \Delta & \defas &
    \models \Gamma \mand \models \Delta \mand
    \sigma \eta = \sigma' \eta' \eeq \tau \rho \in \Delta
    \mforall \eta = \eta' \eeq \rho \in \Gamma
\end{array}
\]

\begin{theorem}[Fundamental theorem]
  \bla
  \begin{enumerate}
  \item
  If $\der \Gamma$ then $\models \Gamma$.
  \item
  If $\Gamma \der J$ then % $\models \Gamma$ and
  $\Gamma \models J$
  \end{enumerate}
\end{theorem}
\begin{proof}
Simultaneously, by induction on the derivation.
% The soundness of subtyping and the conversion rule is due to subsumption (lemmata \ref{lem:subsump} and \ref{lem:usubsump}).

\begin{caselist}
\nextcase $\forall$-introduction.
\[
  \ru{\erext \Gamma \Size \der t = t' : T
    }{\Gamma \der \lambda t = \lambda t' : \forall T}
\]
First $\models \Gamma$ follows from the induction hypothesis $\models {\erext \Gamma \Size}$.
To show $\resurrect\Gamma \models \forall T$,
assume $\eta = \eta' \eeq \rho \in \resurrect \Gamma$
and show $(\forall T)\eta = (\forall T)\eta' \in \SET[\ell]$ for some $\ell$.
To this end, assume $\alpha \in \SIZE$ and show $T(\eta,\alpha) = T(\eta',\alpha) \in \SET[\ell]$.
Note that $(\eta,\alpha) = (\eta',\alpha) \eeq (\rho,\alpha) \in
\resurrect {\erext \Gamma \Size} = \cext {\resurrect\Gamma}\Size$,
thus, we can instantiate the induction hypothesis and obtain our goal.

For the main goal,
assume $\eta = \eta' \eeq \rho \in \Gamma$ and
show $(\lambda t)\eta = (\lambda t')\eta' \in (\forall T)\rho$.
To this end, assume arbitrary $\alpha,\alpha',\beta \in \SIZE$ and show
$t(\eta,\alpha) = t'(\eta',\alpha') \in T(\rho,\beta)$.
Since $(\eta,\alpha) = (\eta',\alpha') \eeq (\rho,\beta) \in \erext \Gamma \Size$,
we conclude by induction hypothesis.

\nextcase $\forall$-elimination.
\[
  \ru{\Gamma \der t = t' : \forall T \qquad
      \Gamma \der a, a' : \Size \qquad
      \resurrect\Gamma \der b : \Size
    }{\Gamma \der t \ann a = t' \ann {a'} : T[b]}
\]
First, $\models \Gamma$ follows by induction hypothesis.
For goal $\resurrect \Gamma \models T[b]$,
assume $\eta = \eta' \eeq \rho \in \resurrect\Gamma$ and show
$T[b]\eta = T[b]\eta' \in \SET[\ell]$ for some $\ell$.
By induction hypothesis,  $b\eta = b\eta' \in \SIZE$.
% , thus,
% $(\eta,b\eta) = (\eta',b\eta') \eeq (\rho,b\eta) \in \cext{\resurrect\Gamma}\Size$
By another induction hypothesis, $(\forall T)\eta = (\forall T)\eta' \in \SET[\ell]$,
which by definition entails our goal $T(\eta, b\eta) = T(\eta', b\eta') \in \SET[\ell]$.


For the remaining main goal,
assume $\eta = \eta' \eeq \rho \in \Gamma$ and
show $t \ann a \eta = t' \ann{a'} \eta' \in T[b]\rho$.
By definition of substitution, it suffices to show
$t \eta \ann{a \eta} = t' \eta' \ann{a' \eta'} \in T(\rho, b \rho)$.
By induction hypothesis,
$t \eta = t' \eta' : (\forall T) \rho$, thus, by definition of this PER,
$t \eta \ann {\alpha_1} = t' \eta' \ann{\alpha_2} \in T(\rho, b')$ for any size values $\alpha_1$, $\alpha_2$, and $b'$.
We conclude by choosing $\alpha_1 = a \eta$ and $\alpha_2 = a' \eta'$ and $b' = b \rho$.

We now argue that this choice is possible,
namely that $a \eta, a'\eta, b\rho \in \SIZE$.
Note that the induction hypothesis gives us
$a \eta  = a  \eta' \in \SIZE$ and
$a' \eta = a' \eta' \in \SIZE$.
By resurrection (Lemma~\ref{lem:resenv}) we have $\rho \in \resurrect\Gamma$,
thus, by induction hypothesis, $b \rho \in \SIZE$.
\end{caselist}
\end{proof}


\subsection{Completeness of NbE}
\label{sec:compl}

\section{Soundness  of NbE}
\label{sec:compl}

In this section, we show that NbE is sound for judgemental equality, i.e., that same normal form implies definitional equality.  The proof follows previous work on NbE \cite{abelCoquandDybjer:lics07,abel:habil}.

\[
  \fbox{$\LRSize \Gamma a \alpha$} \defas
  \forall \sigma : \Gamma' \leq \Gamma.\ \
  \RSize {\Gamma'} \alpha {a\sigma}
  % \exists a'.\
  % \RSize {\Gamma'} \alpha a' \mand
  % \Gamma' \der a\sigma = a' : \Size
\]

\fbox{$\LRT \Gamma {T'} {A'} \ell$} and \fbox{$\LR \Gamma t {T'} f {A'}$} defined by induction on ${A'} \in \SET[\ell]$.

\begin{caselist}

\nextcase $A' \evalsto N$ neutral.

  \noindent
  $\LRT{\Gamma}{T'}{A'}\ell$ iff
  $\forall \sigma : \Gamma' \leq \Gamma.\ \ \exists M.\ \ \RTy{\Gamma'}{A'}M \mand \Gamma' \der T'\sigma = M : \Set[\ell]$.

  \noindent
  $\LR{\Gamma}{t}{T'}{f}{A'}$ iff
  $\forall \sigma : \Gamma' \leq \Gamma.\ \
   \exists m. \ \
   \R {\Gamma'} {\down {A'} f} m \mand
   \Gamma' \der t\sigma = m : T'\sigma$.

\nextcase $A' \evalsto \Nat \alpha$.

  \noindent
  $\LRT{\Gamma}{T'}{A'}\ell$ iff $\Gamma \der T' = \Nat a$ for some $a$ and $\LRSize \Gamma a \alpha$.

  \noindent
  $\LR{\Gamma}{t}{T'}{f}{A'}$ iff $\resurrect\Gamma \der T' = \Nat a$ for some $a$ and
  $\LRSize {\resurrect\Gamma} a \alpha$ and \\
  $\forall \sigma : \Gamma' \leq \Gamma.\ \
   \exists v. \ \
   \R {\Gamma'} {\down {A'} f} v \mand
   \Gamma' \der t\sigma = v : \Nat\,a\sigma$.


\nextcase $A' \evalsto \Set[\ell']$.

  \noindent
  $\LRT {\Gamma} {T'} {A'} \ell$ iff $\Gamma \der T' = \Set[\ell'] : \Set[\ell]$.

  \noindent
  $\LR \Gamma U {T'} B {A'}$ iff
  $\resurrect\Gamma \der T' = \Set[\ell'] : \Set[\ell]$ and $\LRT \Gamma U B {\ell'}$.

\nextcase $A' \evalsto \piT A B$.

\noindent
$\LRT \Gamma {T'} {A'} \ell$ iff
\[
\begin{array}{l}
\Gamma \der T' = \piT U T : \Set[\ell] \mforsome U, T \mand \LRT \Gamma U A \ell \mand \\
\forall \sigma : \Gamma' \leq \Gamma.\ \
\LR {\Gamma'} u {U\sigma} a A \implies \LRT {\Gamma'} {T(\sigma,u)} {B[a]} \ell
. \\
\end{array}
\]
$\LR \Gamma t {T'} f {A'}$ iff
\[
\begin{array}{l}
\resurrect\Gamma \der T' = \piT U T : \Set[\ell] \mforsome U, T \mand \LRT {\resurrect\Gamma} U A \ell \mand \\
\forall \sigma : \Gamma' \leq \Gamma.\ \
\LR {\Gamma'} u {U\sigma} a A \implies \LR {\Gamma'} {t\sigma\,u} {T(\sigma,u)} {f\,a} {B[a]}
.
\end{array}
\]

\nextcase $A' \evalsto \piT \Size B$.

\noindent
$\LRT \Gamma {T'} {A'} \ell$ iff
\[
\begin{array}{l}
\Gamma \der T' = \piT \Size T : \Set[\ell] \mforsome T\\
\forall \sigma : \Gamma' \leq \Gamma.\ \
\LRSize {\Gamma'} a \alpha
\implies \LRT {\Gamma'} {T(\sigma,a)} {B[\alpha]} \ell
.
\end{array}
\]
$\LR \Gamma t {T'} f {A'}$ iff
\[
\begin{array}{l}
\resurrect\Gamma \der T' = \piT \Size T : \Set[\ell] \mforsome T\\
\forall \sigma : \Gamma' \leq \Gamma.\ \
\LRSize {\Gamma'} a \alpha
\implies \LR {\Gamma'} {t\sigma\,a} {T(\sigma,a)} {f\,\alpha} {B[\alpha]}
.
\end{array}
\]

\nextcase $A' \evalsto \forallT B$.

\noindent
$\LRT \Gamma {T'} {A'} \ell$ iff
\[
\begin{array}{l}
\Gamma \der T' = \forallT T : \Set[\ell] \mforsome T\\
\forall \sigma : \Gamma' \leq \Gamma,\
{\Gamma'} \der b : \Size,\
\beta \in \SIZE. \ \
\LRSize {\Gamma'} b \beta
\implies \LRT {\Gamma'} {T(\sigma,b)} {B[\beta]} \ell
.
\end{array}
\]
$\LR \Gamma t {T'} f {A'}$ iff
\[
\begin{array}{l}
\resurrect\Gamma \der T' = \forallT T : \Set[\ell] \mforsome T\\
\forall \sigma : \Gamma' \leq \Gamma,\
\Gamma' \der a : \Size,\
\resurrect{\Gamma'} \der b : \Size,\
\alpha,\beta \in \SIZE. \ \\ \qquad
\LRSize {\resurrect{\Gamma'}} b \beta
\implies \LR {\Gamma'} {t\sigma\,\ann a} {T(\sigma,b)} {f\,\ann\alpha} {B[\beta]}
.
\end{array}
\]

\end{caselist}

\begin{theorem}[Into and out of the logical relation]
  \bla
  Let $A \in \Set[\ell]$.
  \begin{enumerate}

  \item $\LR \Gamma t T {\up A n} A$ if for all $\sigma : \Gamma' \leq \Gamma$ there is an $m$ such that
     $\RNe{\Gamma'}n m$ and $\Gamma' \der t\sigma = m : T$.

  \item If\/ $\LRT{\Gamma} T A \ell$ then for all $\sigma : \Gamma' \leq \Gamma$ there is some normal form $V$ such that
  $\Rty{\Gamma'} A V$ and $\Gamma' \der T\sigma = V : \Set[\ell]$.

  \item If\/ $\LR \Gamma t T f A$ then for all $\sigma : \Gamma' \leq \Gamma$ there is some normal form $v$ such that
  $\R{\Gamma'} {\down A f} v$ and $\Gamma' \der t\sigma = v : T\sigma$.

  \end{enumerate}
\end{theorem}

Logical relation for substitutions.
\fbox{$\LRSub \Gamma \sigma \tau \Delta \eta \rho$}.
\begin{gather*}
  \ru{\der \Gamma
    }{\LRSub \Gamma {\sempty} {\sempty} {\cempty} {\sempty} {\sempty}}
\\[2ex]
  \ru{\LRSub \Gamma \sigma \tau \Delta \eta \rho \qquad
      \resurrect \Delta \der T \qquad
      \Gamma \der u = t : T\tau \qquad
      \LR \Gamma t {T \tau} f {T \rho} \qquad
      f = g \in T\rho
    }{\LRSub \Gamma {(\sigma,u)} {(\tau,t)} {\cext \Delta T} {(\eta,f)} {(\rho,q)}}
\\[2ex]
  \ru{\LRSub \Gamma \sigma \tau \Delta \eta \rho \qquad
      \Gamma \der a : \Size \qquad
      \LRSize \Gamma a \alpha
    }{\LRSub \Gamma {(\sigma,a)} {(\tau,a)} {\cext \Delta \Size} {(\eta,\alpha)} {(\rho,\alpha)}}
\\[2ex]
  \ru{\LRSub \Gamma \sigma \tau \Delta \eta \rho \qquad
      \Gamma \der a, b : \Size \qquad
      \alpha,\beta \in \SIZE \qquad
      \LRSize \Gamma b \beta
    }{\LRSub \Gamma {(\sigma,a)} {(\tau,b)} {\erext \Delta \Size} {(\eta,\alpha)} {(\rho,\beta)}}
\end{gather*}

\begin{lemma}[Properties of the logical relation for substitution]
  \label{lem:wklrsub}
  Let $\LRSub \Gamma \sigma \tau \Delta \eta \rho$.
  \begin{enumerate}
  \item Weakening:
  If $\sigma' : \Gamma' \leq \Gamma$ then
  $\LRSub{\Gamma'}{\sigma\sigma'}{\tau\sigma'}{\Delta}\eta\rho$.
  \item Resurrection:
  Let $\LRSub {\Gamma} \tau \tau {\resurrect\Delta} \rho \rho$.
  \end{enumerate}
\end{lemma}

% \begin{lemma}[Typing of constructed data]
% \label{lem:invdata} \bla
% If\/ $\Gamma \der c : \Nat b$ then $\resurrect\Gamma \der b : \Size$ and $b > 0$.
% \end{lemma}

Validity judgements.
\[
\begin{array}{l@{\quad}l@{\quad}l}
  \Gamma \valid t : T & \defas & %\valid \Gamma \mand
    % \resurrect\Gamma \valid T \mand
    \valid \cext \Gamma T \mand
    \LR {\Gamma'} {t \sigma} {T \tau} {t \eta} {T \rho}
    \mforall \LRSub {\Gamma'} \sigma \tau \Gamma \eta \rho
\\[1ex]
  \Gamma \valid \sigma : \Delta & \defas &
    \LRSub {\Gamma'} {\sigma \sigma'} {\sigma \tau'} \Delta {\sigma \eta'} {\sigma \rho'}
    \mforall \LRSub {\Gamma'} {\sigma'} {\tau'} \Gamma {\eta'} {\rho'}
\end{array}
\]

\begin{theorem}[Fundamental theorem of typing]
  \bla
  \begin{enumerate}
  \item
  If $\Gamma \der t : T$ then $\Gamma \valid t : T$.
  \item
  If $\Gamma \der \sigma : \Delta$ then
  $\Gamma \valid \sigma : \Delta$
  \end{enumerate}
\end{theorem}
\begin{proof}
Each by induction on the derivation.

\begin{caselist}

\nextcase $\forall$-introduction.
\[
  \ru{\erext \Gamma \Size \der t : T
    }{\Gamma \der \lambda t : \forall T}
\]
Assume $\LRSub {\Delta} {\sigma} {\tau} \Gamma {\eta} {\rho}$ and show
$\LR \Delta {(\lambda t)\sigma} {(\forall T)\tau} {(\lambda t)\eta} {(\forall T)\rho}$.
To this end, assume a weakening $\sigma' : \Delta' \leq \Delta$ and
size expressions $\Delta' \der a : \Size$ and
$\resurrect{\Delta'} \der b : \Size$ and size values $\alpha,\beta$ with
$\LRSize {\Delta'} b \beta$ and show
$\LR {\Delta'} {t(\sigma\sigma',a)} {T(\tau\sigma',b)} {t(\eta,\alpha)} {T(\rho,\beta)}$.
This follows from the induction hypothesis, since
$\LRSub {\Delta'} {(\sigma\sigma',a)} {(\tau\sigma',b)} {\erext \Gamma \Size} {(\eta,\alpha)} {(\rho,\beta)}$
by Lemma~\ref{lem:wklrsub} and substitution extension.

\nextcase $\forall$-elimination.
\[
  \ru{\Gamma \der t : \forall T \qquad \Gamma \der a : \Size \qquad \resurrect \Gamma \der b : \Size
    }{\Gamma \der t \ann a : T[b]}
\]
Assume $\LRSub {\Delta} {\sigma} {\tau} \Gamma {\eta} {\rho}$ and show
$\LR \Delta {t \ann a \sigma} {T[b]\tau} {t \ann a \eta} {T[b]\rho}$.
By induction hypothesis we have $\LR \Delta {t \sigma} {(\forall T)\tau} {t \eta} {(\forall T) \rho}$.
It suffices to show
\begin{enumerate}
\item $\Delta \der a\sigma : \Size$
%\item $\resurrect\Delta \der b\tau : \Size$.
 and $a\eta \in \SIZE$: follows by induction hypothesis on $\Gamma \der a : \Size$.
%\item $b\rho \in \SIZE$.
\item $\LRSize {\resurrect \Delta} {b\tau} {b\rho}$: follows from induction hypothesis on $\resurrect \Gamma \der b : \Size$ via $\LRSub {\resurrect \Delta} \tau \tau {\resurrect\Gamma} \rho \rho$ (from Lemma~\ref{lem:wklrsub}).
\end{enumerate}

\end{caselist}
\end{proof}


\section{Conclusions}
\label{sec:concl}

%% Acknowledgments
\begin{acks}                            %% acks environment is optional
                                        %% contents suppressed with 'anonymous'
  %% Commands \grantsponsor{<sponsorID>}{<name>}{<url>} and
  %% \grantnum[<url>]{<sponsorID>}{<number>} should be used to
  %% acknowledge financial support and will be used by metadata
  %% extraction tools.
  This material is based upon work supported by the
  \grantsponsor{GS100000001}{National Science
    Foundation}{http://dx.doi.org/10.13039/100000001} under Grant
  No.~\grantnum{GS100000001}{nnnnnnn} and Grant
  No.~\grantnum{GS100000001}{mmmmmmm}.  Any opinions, findings, and
  conclusions or recommendations expressed in this material are those
  of the author and do not necessarily reflect the views of the
  National Science Foundation.
\end{acks}


%% Bibliography
\bibliography{medium}


%% Appendix
\appendix
\section{Appendix}

Text of appendix \ldots

\end{document}
